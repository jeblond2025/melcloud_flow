# Configure a default setup of Home Assistant (frontend, api, etc)
homeassistant:
  customize: !include customize.yaml
http:
  ssl_certificate: /ssl/fullchain.pem
  ssl_key: /ssl/privkey.pem

default_config:
http:
   # Cloudflare setting to unlock reverse proxy
   use_x_forwarded_for: true
   trusted_proxies:
     - 172.30.33.0/24

#modbus

modbus:
  - type: tcp
    host: 192.168.68.104
    port: 502
    name: froniustest
    sensors:
      - name: contor
        slave: 240
        scan_interval: 3
        address: 40097
        data_type: float32
        device_class: power
        unit_of_measurement: W
        
      - name: ongrid
        slave: 1
        scan_interval: 3
        address: 40091
        data_type: float32
        device_class: power
        unit_of_measurement: W
        
      - name: ongrid2
        slave: 2
        scan_interval: 3
        address: 40091
        data_type: float32
        device_class: power
        unit_of_measurement: W
        
group:
  BoilereAuto:
    name: "Automatizare Boilere"
    entities:
      - automation.boiler1_boiler2
      - automation.boiler1_boiler2_1
      - automation.boiler1_boiler2_1_1
  PompaCalduraAuto:
    name: "Automatizare Pompa Caldura"
    entities:
      - automation.boiler_off_tank_on
      - automation.boiler_off_tank_on_noaptea
      - automation.boiler_on
      - automation.boiler_on_ziua
      - automation.pompa_35_grade
      - automation.test

sensor:
  - platform: template
    sensors:
      totalongrid:
        unit_of_measurement: "W"
        value_template: "{{ (states('sensor.ongrid2') | float) + (states('sensor.ongrid') | float) }}"
      deltaboilere:
        unit_of_measurement: "°C"
        value_template: "{{ ((states('sensor.esphome_web_4297f8_boiler1') | float) - (states('sensor.esphome_web_4297f8_boiler2') | float)) | round(1) }}"
      casa:
        unit_of_measurement: "W"
        value_template: "{{ (states('sensor.contor') | float) + (states('sensor.totalongrid') | float)}}"
        # - (states('sensor.alinapower') | float) - (states('sensor.ukrainapower') | float)
      ukrainapower:
        unit_of_measurement: "W"
        value_template: "{{ (states('sensor.shellyem3_485519d78f0e_channel_a_power') | float ) + (states('sensor.shellyem3_485519d78f0e_channel_b_power') | float) + (states('sensor.shellyem3_485519d78f0e_channel_c_power') | float) }}"  
      alinapower:
        unit_of_measurement: "W"
        value_template: "{{ (states('sensor.shellyem3_485519dca69c_channel_a_power') | float ) + (states('sensor.shellyem3_485519dca69c_channel_b_power') | float) + (states('sensor.shellyem3_485519dca69c_channel_c_power') | float) }}"  
      ukrainaenergy:
        unit_of_measurement: "kWh"
        value_template: "{{ (states('sensor.shellyem3_485519d78f0e_channel_a_energy') | float ) + (states('sensor.shellyem3_485519d78f0e_channel_b_energy') | float) + (states('sensor.shellyem3_485519d78f0e_channel_c_energy') | float) }}"  
      alinaenergy:
        unit_of_measurement: "kWh"
        value_template: "{{ (states('sensor.shellyem3_485519dca69c_channel_a_energy') | float ) + (states('sensor.shellyem3_485519dca69c_channel_b_energy') | float) + (states('sensor.shellyem3_485519dca69c_channel_c_energy') | float) }}"    

# Text to speech
tts:
  - platform: google_translate

# MelCloud Configuration
input_number:
  melcloud_flow_temp:
    name: "MelCloud Flow Temperature"
    initial: 45
    min: 20
    max: 60
    step: 0.5
    unit_of_measurement: "°C"

input_text:
  melcloud_email:
    name: "MelCloud Email"
    initial: ""
  melcloud_password:
    name: "MelCloud Password"
    initial: ""
  melcloud_context_key:
    name: "MelCloud Context Key"
    initial: ""
  melcloud_device_id:
    name: "MelCloud Device ID"
    initial: ""
  melcloud_building_id:
    name: "MelCloud Building ID"
    initial: ""

rest_command:
  melcloud_login:
    url: "https://app.melcloud.com/Mitsubishi.Wifi.Client/Login/ClientLogin"
    method: POST
    headers:
      User-Agent: "Mozilla/5.0 (X11; Linux x86_64; rv:73.0) Gecko/20100101 Firefox/73.0"
      Accept: "application/json, text/javascript, */*; q=0.01"
      Content-Type: "application/json"
      X-Requested-With: "XMLHttpRequest"
    payload: >
      {
        "Email": "{{ states('input_text.melcloud_email') }}",
        "Password": "{{ states('input_text.melcloud_password') }}",
        "Language": 0,
        "AppVersion": "1.19.1.1",
        "Persist": true,
        "CaptchaResponse": null
      }
    response_variable: melcloud_login_response

  melcloud_set_temp:
    url: "https://app.melcloud.com/Mitsubishi.Wifi.Client/Device/SetAtw"
    method: POST
    headers:
      User-Agent: "Mozilla/5.0 (X11; Linux x86_64; rv:73.0) Gecko/20100101 Firefox/73.0"
      Accept: "application/json, text/javascript, */*; q=0.01"
      Content-Type: "application/json"
      X-MitsContextKey: "{{ states('input_text.melcloud_context_key') }}"
      X-Requested-With: "XMLHttpRequest"
      Cookie: "policyaccepted=true"
    payload: >
      {
        "DeviceID": {{ states('input_text.melcloud_device_id') | int }},
        "BuildingID": {{ states('input_text.melcloud_building_id') | int }},
        "SetHeatFlowTemperatureZone1": {{ states('input_number.melcloud_flow_temp') | float }}
      }

  melcloud_get_data:
    url: "https://app.melcloud.com/Mitsubishi.Wifi.Client/Device/Get?id={{ states('input_text.melcloud_device_id') }}&buildingID={{ states('input_text.melcloud_building_id') }}"
    method: GET
    headers:
      User-Agent: "Mozilla/5.0 (X11; Linux x86_64; rv:73.0) Gecko/20100101 Firefox/73.0"
      Accept: "application/json, text/javascript, */*; q=0.01"
      X-MitsContextKey: "{{ states('input_text.melcloud_context_key') }}"
      X-Requested-With: "XMLHttpRequest"
      Cookie: "policyaccepted=true"

# Template sensors pentru temperaturi (folosesc sensor.melcloud_data care este populat de automation)
template:
  - trigger:
      - platform: state
        entity_id: sensor.melcloud_data
    sensor:
      - name: "MelCloud Temperature Tur"
        state: "{{ state_attr('sensor.melcloud_data', 'TankWaterTemperature') | default(state_attr('sensor.melcloud_data', 'RoomTemperatureZone1')) | float(0) }}"
        unit_of_measurement: "°C"
        device_class: temperature
        
      - name: "MelCloud Temperature Retur"
        state: >
          {% set temp = state_attr('sensor.melcloud_data', 'RoomTemperatureZone2') | float(0) %}
          {{ temp if temp != -39.0 else 'unavailable' }}
        unit_of_measurement: "°C"
        device_class: temperature
        
      - name: "MelCloud Temperature Exterioara"
        state: "{{ state_attr('sensor.melcloud_data', 'OutdoorTemperature') | float(0) }}"
        unit_of_measurement: "°C"
        device_class: temperature
        
      - name: "MelCloud Flow Temperature Set"
        state: "{{ state_attr('sensor.melcloud_data', 'SetHeatFlowTemperatureZone1') | default(state_attr('sensor.melcloud_data', 'SetCoolFlowTemperatureZone1')) | float(0) }}"
        unit_of_measurement: "°C"
        device_class: temperature

# IMPORTANT: Automation-urile și script-urile MelCloud trebuie adăugate în automations.yaml și scripts.yaml
# Sau elimină linia cu !include și adaugă-le aici direct
automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

logger:
  logs:
    homeassistant.components.modbus: debug

