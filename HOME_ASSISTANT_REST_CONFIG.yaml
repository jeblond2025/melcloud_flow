# Configurare Home Assistant pentru control direct MelCloud API
# Adaugă aceste configurații în configuration.yaml

# 1. REST Command pentru login și obținere context key
rest_command:
  melcloud_login:
    url: "https://app.melcloud.com/Mitsubishi.Wifi.Client/Login/ClientLogin"
    method: POST
    headers:
      User-Agent: "Mozilla/5.0 (X11; Linux x86_64; rv:73.0) Gecko/20100101 Firefox/73.0"
      Accept: "application/json, text/javascript, */*; q=0.01"
      Content-Type: "application/json"
      X-Requested-With: "XMLHttpRequest"
    payload: >
      {
        "Email": "{{ email }}",
        "Password": "{{ password }}",
        "Language": 0,
        "AppVersion": "1.19.1.1",
        "Persist": true,
        "CaptchaResponse": null
      }
    response_template: >
      {% if response.status == 200 %}
        {% set data = response.json() %}
        {% if data.ErrorId is none or data.ErrorId == null %}
          {{ data.LoginData.ContextKey }}
        {% else %}
          ERROR: {{ data.ErrorMessage }}
        {% endif %}
      {% else %}
        ERROR: Status {{ response.status }}
      {% endif %}

  melcloud_set_flow_temperature:
    url: "https://app.melcloud.com/Mitsubishi.Wifi.Client/Device/SetAtw"
    method: POST
    headers:
      User-Agent: "Mozilla/5.0 (X11; Linux x86_64; rv:73.0) Gecko/20100101 Firefox/73.0"
      Accept: "application/json, text/javascript, */*; q=0.01"
      Content-Type: "application/json"
      X-MitsContextKey: "{{ context_key }}"
      X-Requested-With: "XMLHttpRequest"
      Cookie: "policyaccepted=true"
    payload: "{{ payload }}"

# 2. REST Sensors pentru citirea temperaturilor
rest:
  - resource: "https://app.melcloud.com/Mitsubishi.Wifi.Client/Device/Get?id={{ device_id }}&buildingID={{ building_id }}"
    scan_interval: 60
    headers:
      User-Agent: "Mozilla/5.0 (X11; Linux x86_64; rv:73.0) Gecko/20100101 Firefox/73.0"
      Accept: "application/json, text/javascript, */*; q=0.01"
      X-MitsContextKey: "{{ context_key }}"
      X-Requested-With: "XMLHttpRequest"
      Cookie: "policyaccepted=true"
    sensors:
      - name: "MelCloud Temperature Tur"
        value_template: "{{ value_json.TankWaterTemperature | default(value_json.RoomTemperatureZone1) }}"
        unit_of_measurement: "°C"
        device_class: temperature
        
      - name: "MelCloud Temperature Retur"
        value_template: "{{ value_json.RoomTemperatureZone2 if value_json.RoomTemperatureZone2 != -39.0 else 'unavailable' }}"
        unit_of_measurement: "°C"
        device_class: temperature
        
      - name: "MelCloud Temperature Exterioara"
        value_template: "{{ value_json.OutdoorTemperature }}"
        unit_of_measurement: "°C"
        device_class: temperature
        
      - name: "MelCloud Flow Temperature Set"
        value_template: "{{ value_json.SetHeatFlowTemperatureZone1 | default(value_json.SetCoolFlowTemperatureZone1) }}"
        unit_of_measurement: "°C"
        device_class: temperature

# 3. Input Number pentru setarea flow temperature (20-60°C)
input_number:
  melcloud_flow_temperature:
    name: "MelCloud Flow Temperature"
    initial: 45
    min: 20
    max: 60
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:thermometer

# 4. Template Sensors (opțional, pentru afișare mai bună)
template:
  - sensor:
      - name: "MelCloud Flow Temperature Display"
        state: "{{ states('input_number.melcloud_flow_temperature') }}"
        unit_of_measurement: "°C"
        icon: mdi:thermometer

# 5. Automations pentru setarea temperaturii
automation:
  - alias: "Set MelCloud Flow Temperature"
    trigger:
      - platform: state
        entity_id: input_number.melcloud_flow_temperature
    action:
      - service: rest_command.melcloud_set_flow_temperature
        data_template:
          context_key: "{{ states('input_text.melcloud_context_key') }}"
          payload: >
            {
              "DeviceID": {{ device_id }},
              "BuildingID": {{ building_id }},
              "SetHeatFlowTemperatureZone1": {{ states('input_number.melcloud_flow_temperature') | float }},
              "SetCoolFlowTemperatureZone1": {{ states('input_number.melcloud_flow_temperature') | float }}
            }

# 6. Input Text pentru stocarea context key (obținut din script/automation)
input_text:
  melcloud_context_key:
    name: "MelCloud Context Key"
    initial: ""
    max: 200

# 7. Script pentru login (rulează o dată la pornire sau când expiră context key)
script:
  melcloud_login:
    alias: "MelCloud Login"
    sequence:
      - service: rest_command.melcloud_login
        data:
          email: "YOUR_EMAIL@example.com"
          password: "YOUR_PASSWORD"
      - service: input_text.set_value
        entity_id: input_text.melcloud_context_key
        data_template:
          value: "{{ result }}"

